<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‰²ç¨å°å°å¸« (12.0 å…­å¤§ç²¾éˆå®Œå…¨é«”)</title>
    <style>
        /* --- 1. åŸºç¤è¨­å®š --- */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #2c3e50; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; user-select: none; -webkit-user-select: none; touch-action: manipulation; color: white; min-height: 100vh; }
        .header-box { position: relative; width: 100%; max-width: 400px; text-align: center; margin: 10px 0; }
        h1 { margin: 0; letter-spacing: 2px; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); display: inline-block; }

        /* --- 2. HUD & é ‚éƒ¨ UI --- */
        .hud { display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; max-width: 400px; background: rgba(255, 255, 255, 0.1); padding: 10px 15px; border-radius: 50px; margin-bottom: 10px; box-sizing: border-box; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); align-items: center; text-align: center; }
        .hud-item { font-weight: bold; font-size: 0.85rem; }
        .hud-val { color: #f1c40f; display: block; font-family: monospace; font-size: 1.2rem; }
        .hud-val.urgent { color: #e74c3c; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .top-controls-container { display: flex; width: 100%; max-width: 380px; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 15px; }
        .small-action-btn { font-size: 0.8rem; padding: 6px 12px; border-radius: 8px; font-weight: bold; border: none; color: white; cursor: pointer; transition: 0.2s; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .small-action-btn:active { transform: scale(0.95); }
        .small-action-btn.btn-reset { background-color: #16a085; }
        .small-action-btn.btn-reset:hover { background-color: #1abc9c; }
        .small-action-btn.give-up { background-color: #7f8c8d; }
        .small-action-btn.give-up:hover { background-color: #95a5a6; }
        .small-action-btn.failed { background-color: #c0392b; cursor: not-allowed; }

        .time-bar-container { flex-grow: 1; height: 10px; background: rgba(0,0,0,0.4); border-radius: 5px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .time-bar-fill { height: 100%; width: 100%; background-color: #3498db; transition: width 1s linear, background-color 0.3s ease; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .time-bar-fill.state-purple { background-color: #9b59b6; box-shadow: 0 0 15px #8e44ad, 0 0 5px #fff; animation: electric 0.2s infinite alternate; }
        .time-bar-fill.state-blue { background-color: #3498db; box-shadow: 0 0 5px #2980b9; }
        .time-bar-fill.state-red { background-color: #c0392b; box-shadow: 0 0 15px #e74c3c; animation: shakeBar 0.5s infinite; }
        @keyframes electric { 0% { opacity: 1; box-shadow: 0 0 15px #8e44ad; } 100% { opacity: 0.8; box-shadow: 0 0 25px #d2b4de; } }
        @keyframes shakeBar { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-1px); opacity: 0.8; } 75% { transform: translateX(1px); opacity: 1; } }

        .level-info { margin-top: 5px; font-size: 0.9rem; color: #f1c40f; min-height: 20px; font-weight: bold; text-align: center;}
        .instruction-bar { font-size: 0.85rem; color: #bdc3c7; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; margin-bottom: 10px; white-space: nowrap; text-align: center; }

        /* --- 3. éŠæˆ²å€ --- */
        .game-container { position: relative; width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }
        .main-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; background-color: #34495e; padding: 10px; border-radius: 12px; width: 100%; aspect-ratio: 1 / 1; box-sizing: border-box; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .main-grid.win-glow { box-shadow: 0 0 30px 10px rgba(241, 196, 15, 0.6); border: 2px solid #f1c40f; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 15px 5px rgba(241, 196, 15, 0.4); } 50% { box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.8); } }

        .block { background-color: #ecf0f1; border: 2px solid transparent; position: relative; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; aspect-ratio: 1 / 1; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .block.fixed { border-color: #c0392b; background-color: #fadbd8; }
        .block.user-placed { border-color: #2980b9; }

        /* ğŸŸ£ é—‡å½±ç‰¹æ•ˆ */
        .void-erosion { position: absolute; width: 50%; height: 50%; background: radial-gradient(circle, #000 20%, #8e44ad 80%); box-shadow: 0 0 10px #8e44ad; border-radius: 50%; z-index: 15; pointer-events: none; animation: pulseVoid 1.5s infinite alternate; }
        .void-erosion.corner-0 { top: 0; left: 0; border-top-left-radius: 6px; border-top-right-radius: 50%; border-bottom-left-radius: 50%; }
        .void-erosion.corner-1 { top: 0; right: 0; border-top-right-radius: 6px; border-top-left-radius: 50%; border-bottom-right-radius: 50%; }
        .void-erosion.corner-2 { bottom: 0; left: 0; border-bottom-left-radius: 6px; border-bottom-right-radius: 50%; border-top-left-radius: 50%; }
        .void-erosion.corner-3 { bottom: 0; right: 0; border-bottom-right-radius: 6px; border-bottom-left-radius: 50%; border-top-right-radius: 50%; }
        @keyframes pulseVoid { 0% { transform: scale(0.9); opacity: 0.8; } 100% { transform: scale(1.1); opacity: 1; } }

        /* â„ï¸ å†°å‡ç‰¹æ•ˆ */
        .block.fixed.frozen { border-color: #74b9ff; background-color: transparent; box-shadow: 0 0 15px rgba(116, 185, 255, 0.5), inset 0 0 25px 8px rgba(116, 185, 255, 0.6), inset 0 0 8px 2px rgba(255, 255, 255, 0.8); }
        .block.fixed.frozen .block-image { opacity: 1; }
        .block.fixed.frozen::after { content: "â„ï¸"; position: absolute; top: -2px; right: -2px; font-size: 1rem; filter: drop-shadow(0 0 2px #fff); pointer-events: none; z-index: 16; }

        /* ğŸ”¥ ç‡ƒç‡’ç‰¹æ•ˆ */
        .fire-flash { animation: fireBurn 0.6s forwards; z-index: 50; }
        @keyframes fireBurn { 0% { filter: sepia(1) hue-rotate(-50deg) saturate(5) brightness(1.5); transform: scale(1.1); } 50% { filter: sepia(1) hue-rotate(-50deg) saturate(10) brightness(2); transform: scale(1.2); opacity: 1; } 100% { transform: scale(0); opacity: 0; filter: blur(2px); } }

        .block-image { width: 100%; height: 100%; object-fit: contain; }
        .empty-slot { background-color: rgba(0,0,0,0.2); color: #7f8c8d; font-size: 2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; border: 2px dashed rgba(255,255,255,0.1); border-radius: 6px; position: relative; overflow: hidden; }
        
        .zone-edge { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 11; }
        .zone-center { position: absolute; top: 20%; left: 20%; width: 60%; height: 60%; z-index: 12; border-radius: 50%; }

        /* å…‰æšˆå±¤ */
        .glow-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; border-radius: 12px; overflow: hidden; }
        .glow-bar { position: absolute; box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 8px; transition: opacity 0.3s; }
        .glow-row { left: 1%; width: 98%; height: 31%; background: linear-gradient(to bottom, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 25%, rgba(255,255,255,0) 75%, rgba(255,255,255,0.5) 100%); }
        .glow-col { top: 1%; height: 98%; width: 31%; background: linear-gradient(to right, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 25%, rgba(255,255,255,0) 75%, rgba(255,255,255,0.5) 100%); }
        @keyframes pulseRed { 0%, 100% { box-shadow: inset 0 0 10px rgba(231,76,60,0.5); border-color: #c0392b; } 50% { box-shadow: inset 0 0 20px rgba(231,76,60,0.9); border-color: #e74c3c; } }

        /* --- 4. é¸å–®èˆ‡æŒ‰éˆ• --- */
        .action-btn { background-color: #27ae60; color: white; border: none; padding: 15px 40px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; margin-top: 25px; width: 80%; transition: all 0.2s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .action-btn:active { transform: scale(0.95); }
        
        /* æŠ€èƒ½åˆ— Action Bar (æ¥µè‡´æ’ç‰ˆï¼Œé©æ‡‰ 6 å€‹ç²¾éˆä¸¦æ’) */
        .sprite-action-bar { display: flex; gap: 4px; width: 100%; max-width: 400px; margin-top: 15px; justify-content: center; }
        .sprite-btn { flex: 1; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 5px 1px; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; font-size: 0.75rem; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); white-space: nowrap;}
        .sprite-btn span { font-family: monospace; font-size: 0.95rem; color: #f1c40f; margin-top: 3px; display: block; }
        .sprite-btn.disabled { filter: grayscale(100%); opacity: 0.5; border-color: rgba(255,255,255,0.1); cursor: not-allowed; }
        
        /* å„ç²¾éˆæ¼¸å±¤ä¸»é¡Œè‰² */
        .sprite-btn.theme-holy { background: linear-gradient(135deg, #f39c12, #2c3e50); }
        .sprite-btn.theme-earth { background: linear-gradient(135deg, #27ae60, #2c3e50); }
        .sprite-btn.theme-nature { background: linear-gradient(135deg, #2ecc71, #2c3e50); } /* ç¶ è‰²ç”Ÿéˆ */
        .sprite-btn.theme-shadow { background: linear-gradient(135deg, #8e44ad, #2c3e50); }
        .sprite-btn.theme-ice { background: linear-gradient(135deg, #2980b9, #2c3e50); }
        .sprite-btn.theme-fire { background: linear-gradient(135deg, #d35400, #2c3e50); }

        .flash-intense { animation: flashSkill 0.3s 5 alternate; }
        @keyframes flashSkill { 0% { filter: brightness(1); transform: scale(1); box-shadow: 0 0 5px white; } 100% { filter: brightness(2.5); transform: scale(1.1); box-shadow: 0 0 25px white; border-color: white;} }

        /* ç­‰ç´šé¸æ“‡éˆ• */
        .lvl-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 300px; margin: 20px auto; }
        .lvl-btn { background: #34495e; border: 2px solid #bdc3c7; color: #ecf0f1; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem;}
        .lvl-btn small { font-size: 0.75rem; color: #95a5a6; display: block; margin-top: 4px; font-weight: normal;}
        .lvl-btn.active { background: #f1c40f; border-color: #f39c12; color: #2c3e50; box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); }
        .lvl-btn.active small { color: #555; }
        .name-input { padding: 15px; border-radius: 10px; border: none; font-size: 1.2rem; width: 70%; text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.9); }

        /* --- 5. å½ˆçª—èˆ‡çµç®— --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 95%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 95vh; overflow-y: auto; }
        .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .picker-item { border: 1px solid #ddd; border-radius: 8px; padding: 5px; cursor: pointer; }
        .picker-item img { width: 100%; }
        .percentile-box { background: #e74c3c; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; margin: 8px auto 0; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        
        .level-boards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; width: 100%;}
        .level-board { background: #fff; border: 2px solid #ecf0f1; border-radius: 10px; padding: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
        .level-board-title { font-weight: bold; color: #2980b9; text-align: center; margin-bottom: 5px; border-bottom: 2px solid #3498db; padding-bottom: 4px; font-size: 0.9rem;}
        .lb-mini-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; text-align: left; }
        .lb-mini-table td { padding: 5px 2px; border-bottom: 1px dashed #ecf0f1; vertical-align: middle; }
        .lb-mini-table tr:last-child td { border-bottom: none; }
        .lb-mini-table .rank { font-weight: bold; color: #f39c12; width: 15px; text-align: center;}
        .lb-mini-table .name { font-weight: bold; color: #34495e; max-width: 60px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lb-mini-table .score-time { text-align: right; color: #7f8c8d; font-family: monospace; line-height: 1.2;}
        .lb-mini-table .hint-icon { color: #f39c12; font-size: 0.75rem; }

        #start-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #2c3e50; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .intro-box { text-align: center; padding: 20px; width: 100%; box-sizing: border-box;}
        .intro-title { font-size: 2.5rem; color: #f1c40f; margin-bottom: 10px; letter-spacing: 3px; }
        .intro-desc { font-size: 1.1rem; color: #ecf0f1; margin-bottom: 20px; line-height: 1.8; }
        .tut-highlight-blue { border: 3px dashed #3498db !important; animation: pulseBlue 1.5s infinite; background-color: rgba(52, 152, 219, 0.2); }
        .tut-highlight-yellow { box-shadow: 0 0 15px 5px #f1c40f; border: 2px solid #f1c40f !important; animation: pulseYellow 1.5s infinite; }
        @keyframes pulseBlue { 0%, 100% { box-shadow: 0 0 5px #3498db; } 50% { box-shadow: 0 0 15px #3498db; } }
        @keyframes pulseYellow { 0%, 100% { box-shadow: 0 0 5px #f1c40f; } 50% { box-shadow: 0 0 20px #f1c40f; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="intro-box">
            <div class="intro-title">ğŸ”®è‰²ç¨å°å°å¸«ğŸ”®</div>
            <div class="intro-desc"><strong>å¸¶è¶Šå°‘ç²¾éˆï¼Œæ’è¡Œæ¦œè¶Šé«˜åˆ†ï¼</strong></div>
            <div class="lvl-btn-group">
                <button class="lvl-btn active" onclick="selectLevel(1, this)">LEVEL 1<br><small>Shape 01-12</small></button>
                <button class="lvl-btn" onclick="selectLevel(2, this)">LEVEL 2<br><small>Shape 13-24</small></button>
                <button class="lvl-btn" onclick="selectLevel(3, this)">LEVEL 3<br><small>Shape 25-36</small></button>
                <button class="lvl-btn" onclick="selectLevel(4, this)">LEVEL 4<br><small>Shape 37-48</small></button>
                <button class="lvl-btn" onclick="selectLevel(5, this)">LEVEL 5<br><small>Shape 49-60</small></button>
                <button class="lvl-btn" onclick="selectLevel(6, this)">LEVEL 6<br><small>Shape 61-72</small></button>
            </div>
            
            <div style="margin: 15px auto; display: flex; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); width: 90%; max-width: 320px; text-align: left;">
                <div style="color: #ecf0f1; font-weight: bold; text-align: center; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">ã€ å…­å¤§ç²¾éˆæ®¿å ‚ (å¯é¸ 0~6) ã€‘</div>
                
                <label style="color: #f1c40f; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="holy-assist-toggle" style="transform: scale(1.3);"> 
                    âœ¨ è–å…‰ç²¾éˆ (ä¸»å‹•: ç…§äº®æ­£ç¢ºæ–¹å¡Š, 2æ¬¡/å ´)
                </label>
                <label style="color: #27ae60; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="earth-assist-toggle" style="transform: scale(1.3);"> 
                    ğŸŸ¤ å¤§åœ°ç²¾éˆ (ä¸»å‹•: æ¶ˆé™¤ä¸€å€‹ç©ºæ ¼, 2æ¬¡/å ´)
                </label>
                <label style="color: #2ecc71; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="nature-assist-toggle" style="transform: scale(1.3);"> 
                    ğŸŸ¢ ç”Ÿéˆç²¾éˆ (ä¸»å‹•: é€†è½‰æ™‚ç©ºé‡ç½®, 1æ¬¡/é—œ)
                </label>
                <label style="color: #9b59b6; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="shadow-assist-toggle" style="transform: scale(1.3);"> 
                    ğŸŸ£ é—‡å½±ç²¾éˆ (è¢«å‹•: 20s ä¾µè•æ–¹å¡Šæˆç™¾æ­)
                </label>
                <label style="color: #74b9ff; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="ice-assist-toggle" style="transform: scale(1.3);"> 
                    â„ï¸ å†°é›ªç²¾éˆ (è¢«å‹•: 50s å‡çµçµ•å°æ­£ç¢ºæ–¹å¡Š)
                </label>
                <label style="color: #ff7675; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="fire-assist-toggle" style="transform: scale(1.3);"> 
                    ğŸ”¥ ç«ç„°ç²¾éˆ (è¢«å‹•: 30s ç‡’æ¯€å ´ä¸ŠéŒ¯èª¤æ–¹å¡Š)
                </label>
            </div>

            <input type="text" id="player-name" class="name-input" placeholder="è«‹è¼¸å…¥å°å°å¸«åè™Ÿ" maxlength="10">
            <button class="action-btn" onclick="startGame()" style="margin-top: 0;">é–‹å§‹æŒ‘æˆ°</button>
            <button class="action-btn" onclick="playIntroTutorial()" style="margin-top: 15px; width: 70%; background-color: #8e44ad; padding: 10px;">ğŸ“– æ–°æ‰‹å¼•å°</button>
        </div>
    </div>

    <div class="header-box"><h1 id="game-title">Round 1</h1></div>
    
    <div class="hud">
        <div class="hud-item">é—œå¡ <span id="round-disp" class="hud-val">1/6</span></div>
        <div class="hud-item">å€’æ•¸ <span id="timer-disp" class="hud-val">04:00</span></div>
        <div class="hud-item">å¾—åˆ† <span id="score-disp" class="hud-val">0</span></div>
    </div>

    <div id="top-ui-controls" class="top-controls-container">
        <button id="btn-reset" class="small-action-btn btn-reset" onclick="resetLevel()">ğŸ”„ é‡ç½®</button>
        <div class="time-bar-container"><div id="time-bar-fill" class="time-bar-fill"></div></div>
        <button id="btn-solve" class="small-action-btn give-up" onclick="forceSolve(true)">ğŸ³ï¸ æ”¾æ£„</button>
    </div>

    <div class="game-container">
        <div class="level-info" id="level-info"></div>
        <div id="intro-tut-msg" style="display:none; background: rgba(0,0,0,0.85); color: #ecf0f1; padding: 15px; text-align: left; font-size: 1rem; border-radius: 10px; border: 2px solid #3498db; margin-bottom: 10px; width: 100%; box-sizing: border-box; line-height: 1.6; z-index: 50;"></div>

        <div class="instruction-bar">ğŸ‘†è¼•é»ä¸­é–“ç¿»é¢ | ğŸ”„è¼•é»é‚Šç·£æ—‹è½‰ | ğŸ—‘ï¸é•·æŒ‰ä¸­é–“ç§»é™¤</div>
        <div id="grid-container" class="main-grid"></div>
        <button id="btn-next" class="action-btn" style="display:none;" onclick="nextLevel()">ä¸‹ä¸€é—œ â¡ï¸</button>
        
        <div id="sprite-action-bar" class="sprite-action-bar"></div>
    </div>

    <div id="picker-modal" class="modal-overlay" onclick="closePicker()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="picker-title">é¸æ“‡é­”çŸ³ (Bé¢)</h3>
            <div id="picker-grid" class="picker-grid"></div>
            <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
                <button onclick="togglePickerFace()" style="padding:10px 20px; background:#9b59b6; color:white; border:none; border-radius:20px; font-weight:bold;">ğŸ”„ ç¿»é¢</button>
                <button onclick="closePicker()" style="padding:10px 20px; background:#ddd; border:none; border-radius:20px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="end-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="background:#f4f6f7; padding:15px 10px; border-radius:10px; margin-bottom:15px;">
                <div style="font-size:1.1rem; color:#2c3e50; font-weight:bold; margin-bottom: 5px;" id="end-player-name"></div>
                <div style="font-size:0.9rem; color:#8e44ad; font-weight:bold; margin-bottom: 10px;" id="end-title-desc"></div>
                
                <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap;">
                    <div>å¾—åˆ† <span id="end-score" style="color:#27ae60; font-weight:bold; font-size:1.1rem;">0</span></div>
                    <div>ğŸ§šç²¾éˆæ•¸ <span id="end-hints" style="color:#f39c12; font-weight:bold; font-size:1.1rem;">0</span></div>
                    <div>è€—æ™‚ <span id="end-time" style="color:#e67e22; font-weight:bold; font-size:1.1rem;">00:00</span></div>
                </div>
                <div class="percentile-box" id="end-percentile">ğŸ† æ“Šæ•—äº†å…¨æœ 100% çš„ç©å®¶</div>
            </div>

            <div class="level-boards-container" id="level-boards"></div>
            <button class="action-btn" style="margin-top:20px; padding:10px 30px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(), gainNode = audioCtx.createGain(), now = audioCtx.currentTime;
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            
            if (type === 'action') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'line') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.3);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'win') {
                playNote(523.25, now, 0.1); playNote(659.25, now + 0.1, 0.1); playNote(783.99, now + 0.2, 0.4); 
            } else if (type === 'bonus') {
                playNote(880, now, 0.1); playNote(1760, now + 0.1, 0.2); 
            } else if (type === 'reset') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'fire') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
                gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'ice') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1);
                gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'shadow') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.4);
                gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            }
        }
        function playNote(freq, time, dur) {
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'square'; osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, time); gain.gain.exponentialRampToValueAtTime(0.01, time + dur);
            osc.start(time); osc.stop(time + dur);
        }

        const BLOCKS={1:{B:[[1,2],[3,4]],W:[[5,6],[3,4]]},2:{B:[[4,6],[3,5]],W:[[2,6],[1,5]]},3:{B:[[2,1],[6,5]],W:[[3,4],[1,2]]},4:{B:[[5,2],[6,3]],W:[[4,1],[5,2]]},5:{B:[[4,5],[1,2]],W:[[3,4],[6,1]]},6:{B:[[1,4],[6,3]],W:[[6,3],[5,2]]},7:{B:[[1,6],[5,4]],W:[[2,3],[6,1]]},8:{B:[[2,6],[3,1]],W:[[2,4],[3,5]]},9:{B:[[2,3],[4,5]],W:[[6,1],[4,5]]}};
        const TARGET_TILES=[{id:1,blocks:[{id:1,f:'B'},{id:5,f:'B'},{id:9,f:'B'}]},{id:2,blocks:[{id:2,f:'B'},{id:6,f:'B'},{id:7,f:'B'}]},{id:3,blocks:[{id:3,f:'B'},{id:4,f:'B'},{id:8,f:'B'}]},{id:4,blocks:[{id:3,f:'B'},{id:5,f:'B'},{id:7,f:'B'}]},{id:5,blocks:[{id:1,f:'B'},{id:6,f:'B'},{id:8,f:'B'}]},{id:6,blocks:[{id:2,f:'B'},{id:4,f:'B'},{id:9,f:'B'}]},{id:7,blocks:[{id:1,f:'B'},{id:5,f:'B'},{id:8,f:'W'}]},{id:8,blocks:[{id:2,f:'B'},{id:9,f:'B'},{id:6,f:'W'}]},{id:9,blocks:[{id:6,f:'B'},{id:1,f:'W'},{id:7,f:'B'}]},{id:10,blocks:[{id:9,f:'W'},{id:3,f:'B'},{id:4,f:'W'}]},{id:11,blocks:[{id:2,f:'W'},{id:7,f:'W'},{id:4,f:'B'}]},{id:12,blocks:[{id:5,f:'W'},{id:3,f:'W'},{id:8,f:'B'}]},{id:13,blocks:[{id:5,f:'B'},{id:3,f:'B'},{id:9,f:'W'}]},{id:14,blocks:[{id:1,f:'B'},{id:5,f:'W'},{id:8,f:'B'}]},{id:15,blocks:[{id:4,f:'B'},{id:8,f:'B'},{id:2,f:'W'}]},{id:16,blocks:[{id:3,f:'B'},{id:6,f:'W'},{id:7,f:'W'}]},{id:17,blocks:[{id:9,f:'W'},{id:6,f:'B'},{id:1,f:'W'}]},{id:18,blocks:[{id:4,f:'W'},{id:2,f:'W'},{id:7,f:'B'}]},{id:19,blocks:[{id:3,f:'B'},{id:4,f:'B'},{id:7,f:'W'}]},{id:20,blocks:[{id:9,f:'B'},{id:4,f:'W'},{id:1,f:'B'}]},{id:21,blocks:[{id:7,f:'B'},{id:5,f:'B'},{id:2,f:'W'}]},{id:22,blocks:[{id:6,f:'W'},{id:8,f:'W'},{id:2,f:'B'}]},{id:23,blocks:[{id:5,f:'B'},{id:8,f:'W'},{id:3,f:'W'}]},{id:24,blocks:[{id:1,f:'W'},{id:9,f:'B'},{id:6,f:'W'}]},{id:25,blocks:[{id:2,f:'B'},{id:6,f:'B'},{id:9,f:'W'}]},{id:26,blocks:[{id:7,f:'B'},{id:4,f:'W'},{id:3,f:'B'}]},{id:27,blocks:[{id:9,f:'B'},{id:4,f:'B'},{id:1,f:'W'}]},{id:28,blocks:[{id:1,f:'B'},{id:8,f:'W'},{id:4,f:'W'}]},{id:29,blocks:[{id:9,f:'W'},{id:5,f:'B'},{id:2,f:'W'}]},{id:30,blocks:[{id:8,f:'B'},{id:6,f:'W'},{id:2,f:'W'}]},{id:31,blocks:[{id:1,f:'B'},{id:6,f:'B'},{id:7,f:'W'}]},{id:32,blocks:[{id:3,f:'B'},{id:8,f:'B'},{id:6,f:'W'}]},{id:33,blocks:[{id:5,f:'B'},{id:9,f:'B'},{id:3,f:'W'}]},{id:34,blocks:[{id:1,f:'B'},{id:5,f:'W'},{id:7,f:'W'}]},{id:35,blocks:[{id:8,f:'W'},{id:4,f:'B'},{id:1,f:'W'}]},{id:36,blocks:[{id:3,f:'W'},{id:4,f:'W'},{id:9,f:'B'}]},{id:37,blocks:[{id:4,f:'B'},{id:2,f:'B'},{id:8,f:'W'}]},{id:38,blocks:[{id:2,f:'B'},{id:5,f:'W'},{id:7,f:'B'}]},{id:39,blocks:[{id:8,f:'B'},{id:6,f:'B'},{id:3,f:'W'}]},{id:40,blocks:[{id:5,f:'W'},{id:2,f:'B'},{id:9,f:'W'}]},{id:41,blocks:[{id:3,f:'W'},{id:7,f:'W'},{id:6,f:'B'}]},{id:42,blocks:[{id:7,f:'B'},{id:5,f:'W'},{id:1,f:'W'}]},{id:43,blocks:[{id:1,f:'W'},{id:5,f:'W'},{id:9,f:'W'}]},{id:44,blocks:[{id:2,f:'W'},{id:6,f:'W'},{id:7,f:'W'}]},{id:45,blocks:[{id:3,f:'W'},{id:4,f:'W'},{id:8,f:'W'}]},{id:46,blocks:[{id:3,f:'W'},{id:5,f:'W'},{id:7,f:'W'}]},{id:47,blocks:[{id:1,f:'W'},{id:6,f:'W'},{id:8,f:'W'}]},{id:48,blocks:[{id:2,f:'W'},{id:4,f:'W'},{id:9,f:'W'}]}];
        const SHAPES=[{id:1,name:"No.001",active:[2,3,4,9],targets:[2,4,9]},{id:2,name:"No.002",active:[2,4,6,7],targets:[2,6,7]},{id:3,name:"No.003",active:[1,3,5,9],targets:[1,5,9]},{id:4,name:"No.004",active:[1,3,4,8],targets:[3,4,8]},{id:5,name:"No.005",active:[1,2,6,8],targets:[1,6,8]},{id:6,name:"No.006",active:[1,3,5,7],targets:[3,5,7]},{id:7,name:"No.007",active:[2,4,7,9],targets:[2,4,9]},{id:8,name:"No.008",active:[2,6,7,8],targets:[2,6,7]},{id:9,name:"No.009",active:[1,5,8,9],targets:[1,5,9]},{id:10,name:"No.010",active:[3,4,8,9],targets:[3,4,8]},{id:11,name:"No.011",active:[1,4,6,8],targets:[1,6,8]},{id:12,name:"No.012",active:[3,5,7,8],targets:[3,5,7]},{id:13,name:"No.013",active:[2,3,4,7,9],targets:[2,4,9]},{id:14,name:"No.014",active:[2,4,6,7,8],targets:[2,6,7]},{id:15,name:"No.015",active:[1,3,5,8,9],targets:[1,5,9]},{id:16,name:"No.016",active:[1,3,4,8,9],targets:[3,4,8]},{id:17,name:"No.017",active:[1,2,4,6,8],targets:[1,6,8]},{id:18,name:"No.018",active:[1,3,5,7,8],targets:[3,5,7]},{id:19,name:"No.019",active:[2,4,5,8,9],targets:[2,4,9]},{id:20,name:"No.020",active:[2,6,7,8,9],targets:[2,6,7]},{id:21,name:"No.021",active:[1,2,5,8,9],targets:[1,5,9]},{id:22,name:"No.022",active:[2,3,4,5,8],targets:[3,4,8]},{id:23,name:"No.023",active:[1,2,3,6,8],targets:[1,6,8]},{id:24,name:"No.024",active:[2,3,5,7,8],targets:[3,5,7]},{id:25,name:"No.025",active:[2,4,6,7,8,9],targets:[2,4,9]},{id:26,name:"No.026",active:[2,4,5,6,7,9],targets:[2,6,7]},{id:27,name:"No.027",active:[1,3,5,7,8,9],targets:[1,5,9]},{id:28,name:"No.028",active:[2,3,4,6,8,9],targets:[3,4,8]},{id:29,name:"No.029",active:[1,2,5,6,7,8],targets:[1,6,8]},{id:30,name:"No.030",active:[1,3,5,6,7,9],targets:[3,5,7]},{id:31,name:"No.031",active:[2,4,5,6,8,9],targets:[2,4,9]},{id:32,name:"No.032",active:[2,5,6,7,8,9],targets:[2,6,7]},{id:33,name:"No.033",active:[1,2,3,5,6,9],targets:[1,5,9]},{id:34,name:"No.034",active:[2,3,4,5,6,8],targets:[3,4,8]},{id:35,name:"No.035",active:[1,2,3,5,6,8],targets:[1,6,8]},{id:36,name:"No.036",active:[1,2,3,4,5,7],targets:[3,5,7]},{id:37,name:"No.037",active:[1,2,4,5,6,8,9],targets:[2,4,9]},{id:38,name:"No.038",active:[1,2,4,6,7,8,9],targets:[2,6,7]},{id:39,name:"No.039",active:[1,3,5,6,7,8,9],targets:[1,5,9]},{id:40,name:"No.040",active:[2,3,4,5,6,7,8],targets:[3,4,8]},{id:41,name:"No.041",active:[1,2,3,4,6,8,9],targets:[1,6,8]},{id:42,name:"No.042",active:[1,3,4,5,7,8,9],targets:[3,5,7]},{id:43,name:"No.043",active:[1,2,3,4,6,7,9],targets:[2,4,9]},{id:44,name:"No.044",active:[2,4,5,6,7,8,9],targets:[2,6,7]},{id:45,name:"No.045",active:[1,3,4,5,6,7,9],targets:[1,5,9]},{id:46,name:"No.046",active:[1,2,3,4,7,8,9],targets:[3,4,8]},{id:47,name:"No.047",active:[1,2,4,5,6,7,8],targets:[1,6,8]},{id:48,name:"No.048",active:[1,2,3,5,7,8,9],targets:[3,5,7]},{id:49,name:"No.049",active:[2,3,4,5,6,7,8,9],targets:[2,4,9]},{id:50,name:"No.050",active:[1,2,3,4,6,7,8,9],targets:[2,6,7]},{id:51,name:"No.051",active:[1,3,4,5,6,7,8,9],targets:[1,5,9]},{id:52,name:"No.052",active:[1,2,3,4,5,6,8,9],targets:[3,4,8]},{id:53,name:"No.053",active:[1,2,3,4,6,7,8,9],targets:[1,6,8]},{id:54,name:"No.054",active:[1,2,3,5,6,7,8,9],targets:[3,5,7]},{id:55,name:"No.055",active:[1,2,3,5,6,7,8,9],targets:[2,4,9]},{id:56,name:"No.056",active:[2,4,5,6,7,8,9],targets:[2,6,7]},{id:57,name:"No.057",active:[1,3,4,5,6,7,9],targets:[1,5,9]},{id:58,name:"No.058",active:[1,2,3,4,7,8,9],targets:[3,4,8]},{id:59,name:"No.059",active:[1,2,4,5,6,7,8],targets:[1,6,8]},{id:60,name:"No.060",active:[1,2,3,5,7,8,9],targets:[3,5,7]},{id:61,name:"No.061",active:[1,2,3,4,5,6,7,8,9],targets:[2,4,9]},{id:62,name:"No.062",active:[1,2,3,4,5,6,7,8,9],targets:[2,6,7]},{id:63,name:"No.063",active:[1,2,3,4,5,6,7,8,9],targets:[1,5,9]},{id:64,name:"No.064",active:[1,2,3,4,5,6,7,8,9],targets:[3,4,8]},{id:65,name:"No.065",active:[1,2,3,4,5,6,7,8,9],targets:[1,6,8]},{id:66,name:"No.066",active:[1,2,3,4,5,6,7,8,9],targets:[3,5,7]},{id:67,name:"No.067",active:[1,2,3,4,5,6,7,8,9],targets:[2,4,9]},{id:68,name:"No.068",active:[1,2,3,4,5,6,7,8,9],targets:[2,6,7]},{id:69,name:"No.069",active:[1,2,3,4,5,6,7,8,9],targets:[1,5,9]},{id:70,name:"No.070",active:[1,2,3,4,5,6,7,8,9],targets:[3,4,8]},{id:71,name:"No.071",active:[1,2,3,4,5,6,7,8,9],targets:[1,6,8]},{id:72,name:"No.072",active:[1,2,3,4,5,6,7,8,9],targets:[3,5,7]}];
        const ROUND_SETTINGS={1:{time:330,base:12,bonus:1},2:{time:300,base:12,bonus:2},3:{time:270,base:13,bonus:3},4:{time:240,base:13,bonus:4},5:{time:210,base:14,bonus:5},6:{time:180,base:14,bonus:6}};

        // --- è®Šæ•¸ ---
        let playerName = "", selectedLevel = 1, roundPool = [], currentRound = 1;
        let totalScore = 0, totalTimeSpent = 0, roundStartTime = 0; 
        let currentLayoutConfig = {}, userBoard = Array(9).fill(null);
        let pickingSlot = -1, isRoundWon = false, isSolverUsed = false;
        let timerInterval, timeLeft = 0, currentTotalTime = 0, lastValidLineCount = 0;
        let longPressTimer, pickerFace = 'B'; 

        // æ’è¡Œæ¦œç”¨ï¼šé–‹å±€æ”œå¸¶ç²¾éˆæ•¸
        let selectedSpriteCount = 0;

        // çµ•å°å”¯ä¸€è§£ç­” (ä¾›å†°é›ªç²¾éˆèˆ‡å…¬ä½ˆè§£ç­”ä½¿ç”¨)
        let absoluteSolution = null;

        // ä¸»å‹•æŠ€ç²¾éˆç³»çµ± (è–å…‰/å¤§åœ°/ç”Ÿéˆ)
        let isHolyEnabled = false;
        let isEarthEnabled = false;
        let isNatureEnabled = false;
        let holyLightUses = 2;  
        let earthUses = 2;
        let natureUses = 1; // ç”Ÿéˆç²¾éˆï¼šæ¯é—œ 1 æ¬¡
        let activeHint = null;   

        // --- 9.0 çµ±æ•´è¢«å‹•ç²¾éˆæŠ€èƒ½ç³»çµ± ---
        const SPRITES = {
            shadow: { id: 'shadow', name: 'ğŸŸ£ é—‡å½±', cd: 20, timer: 20, active: false, paused: false, theme: 'theme-shadow' },
            ice: { id: 'ice', name: 'â„ï¸ å†°é›ª', cd: 50, timer: 50, active: false, paused: false, theme: 'theme-ice' },
            fire: { id: 'fire', name: 'ğŸ”¥ ç«ç„°', cd: 30, timer: 30, active: false, paused: false, theme: 'theme-fire' }
        };

        // ç²¾éˆç‹€æ…‹é—œè¯è®Šæ•¸
        let unneededBlocks = []; 
        let permanentlyRemovedBlocks = new Set();
        let solutionFixedRotations = new Map(); 
        let frozenBlocks = new Set(); 
        
        let shadowTargetIndices = []; 
        let shadowEaten = {}; 
        let shadowTurn = 0; 
        
        let originalLevelInfoText = ""; 

        // --- æ²‰æµ¸å¼æ•™å­¸ç³»çµ± ---
        let introTutPhase = 0;

        function playIntroTutorial() {
            $('start-screen').style.display = 'none';
            document.querySelector('.hud').style.display = 'none';
            $('top-ui-controls').style.display = 'none';
            $('level-info').style.display = 'none';
            $('sprite-action-bar').style.display = 'none';
            $('btn-next').style.display = 'none';
            document.querySelector('.instruction-bar').style.display = 'none';
            
            $('game-title').innerText = "æ–°æ‰‹å¼•å°";
            $('intro-tut-msg').style.display = 'block';
            $('grid-container').classList.remove('win-glow');
            isRoundWon = false;

            currentLayoutConfig = {};
            for(let i=0; i<9; i++) currentLayoutConfig[i] = { type: 'EMPTY' };
            const shape = SHAPES[0], tile = TARGET_TILES[0]; 
            shape.active.forEach(pos => { currentLayoutConfig[pos-1] = { type: 'SOLVE' }; });
            shape.targets.forEach((pos, idx) => {
                if (idx < tile.blocks.length) {
                    const b = tile.blocks[idx];
                    currentLayoutConfig[pos-1] = { type: 'FIXED', id: b.id, face: b.f };
                } else { currentLayoutConfig[pos-1] = { type: 'SOLVE' }; }
            });

            userBoard = Array(9).fill(null);
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') {
                    userBoard[i] = { id: currentLayoutConfig[i].id, face: currentLayoutConfig[i].face, rot: 0, isFixed: true };
                }
            }
            
            setIntroPhase(1);
        }

        function setIntroPhase(phase) {
            introTutPhase = phase;
            const msgBox = $('intro-tut-msg');
            if (phase === 1) {
                msgBox.innerHTML = `å‰å¤§çš„å°å°å¸«ï¼Œæº–å‚™å¥½è‰²ç¨å°å°çš„æŒ‘æˆ°å—ï¼Ÿï¼<br><span style="color:#e74c3c">ç´…è‰²æ–¹æ¡†</span>æŒ‡å®šé­”çŸ³å¯æ—‹è½‰ä½†ä¸èƒ½ç¿»é¢ï¼Œ<br><span style="color:#3498db">è—è‰²æ–¹æ¡†</span>è‡ªé¸é­”çŸ³å¯æ—‹è½‰å’Œç¿»é¢ï¼Œ<br>é»æ“Š <span style="color:#3498db; font-weight:bold;">è—è‰²æ–¹æ¡†</span> åŠ å…¥2è™Ÿé­”çŸ³ä¾†å®Œæˆæ–¹é™£ã€‚`;
                renderGameGrid();
            } else if (phase === 2) {
                msgBox.innerHTML = `ç¿»é¢å¯çœ‹é­”çŸ³èƒŒé¢ï¼Œå–æ¶ˆå¯å›åˆ°é­”çŸ³æ–¹é™£ï¼Œ<br>è«‹é»é¸ <span style="color:#f1c40f; font-weight:bold;">2è™Ÿé­”çŸ³</span> åŠ å…¥é­”çŸ³æ–¹é™£ï¼`;
            } else if (phase === 3) {
                msgBox.innerHTML = `è«‹é»æ“Š <span style="color:#f1c40f; font-weight:bold;">é­”çŸ³é‚Šç·£</span>ä¾†æ—‹è½‰ï¼Œ<br>è«‹é»æ“Š <span style="color:#f1c40f; font-weight:bold;">é­”çŸ³ä¸­é–“</span>ä¾†ç¿»é¢ï¼Œ<br>æ‰€æœ‰è¡Œåˆ—å¯¶çŸ³ä¸åŒå°±å¯å®Œæˆå°å°ã€‚`;
                renderGameGrid(); 
            } else if (phase === 4) {
                msgBox.innerHTML = `<div style="text-align:center; color:#27ae60; font-weight:bold; font-size:1.3rem;">ğŸ‰ æ­ç¦§å®Œæˆè‰²ç¨å°å°ï¼</div>`;
                playSound('win');
                $('grid-container').classList.add('win-glow');
                
                setTimeout(() => {
                    introTutPhase = 0;
                    $('intro-tut-msg').style.display = 'none';
                    document.querySelector('.hud').style.display = 'grid';
                    $('top-ui-controls').style.display = 'flex';
                    $('level-info').style.display = 'block';
                    $('sprite-action-bar').style.display = 'flex';
                    document.querySelector('.instruction-bar').style.display = 'block';
                    $('grid-container').classList.remove('win-glow');
                    $('start-screen').style.display = 'flex';
                }, 2500);
            }
        }

        function selectLevel(lvl, btn) {
            selectedLevel = lvl;
            document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); playSound('action');
        }

        function getShapesByLevel(lvl) {
            let pool = SHAPES.filter(s => {
                if (lvl===1) return s.id>=1 && s.id<=12;
                if (lvl===2) return s.id>=13 && s.id<=24;
                if (lvl===3) return s.id>=25 && s.id<=36;
                if (lvl===4) return s.id>=37 && s.id<=48;
                if (lvl===5) return s.id>=49 && s.id<=60;
                return s.id>=61 && s.id<=72;
            });
            return pool.sort(() => Math.random() - 0.5).slice(0, 6);
        }

        function startGame() {
            const nameInput = $('player-name').value.trim();
            if (!nameInput) return alert("è«‹è¼¸å…¥å°å°å¸«åè™Ÿï¼");
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // è®€å–ç²¾éˆé–‹é—œèˆ‡çµ±è¨ˆæ•¸é‡ (æ’è¡Œæ¦œç”¨)
            isHolyEnabled = $('holy-assist-toggle').checked;
            isEarthEnabled = $('earth-assist-toggle').checked;
            isNatureEnabled = $('nature-assist-toggle').checked;
            SPRITES.shadow.active = $('shadow-assist-toggle').checked;
            SPRITES.ice.active = $('ice-assist-toggle').checked;
            SPRITES.fire.active = $('fire-assist-toggle').checked;
            
            selectedSpriteCount = [isHolyEnabled, isEarthEnabled, isNatureEnabled, SPRITES.shadow.active, SPRITES.ice.active, SPRITES.fire.active].filter(Boolean).length;
            
            playerName = nameInput; $('start-screen').style.display = 'none';
            currentRound = 1; totalScore = 0; totalTimeSpent = 0; 
            
            // æ•´å ´éŠæˆ²çš„ä¸»å‹•æŠ€é¡åº¦åœ¨æ­¤é‡ç½®
            holyLightUses = 2;  
            earthUses = 2;

            roundPool = getShapesByLevel(selectedLevel);
            updateHUD(); loadRound(currentRound);
        }

        function loadRound(round) {
            isRoundWon = false; isSolverUsed = false; lastValidLineCount = 0;
            activeHint = null; 

            $('game-title').innerText = `Round ${round}`;
            $('btn-next').style.display = 'none';
            $('top-ui-controls').style.display = 'flex';
            
            let btnSolve = $('btn-solve'), btnReset = $('btn-reset');
            btnSolve.style.display = 'block'; btnSolve.disabled = false;
            btnSolve.innerText = "ğŸ³ï¸ æ”¾æ£„"; btnSolve.className = "small-action-btn give-up";
            btnReset.style.display = 'block'; btnReset.disabled = false;
            
            $('grid-container').classList.remove('win-glow');
            $('timer-disp').classList.remove('urgent');

            const config = ROUND_SETTINGS[round];
            
            let solvable = false, attempts = 0, selectedShape = roundPool[round - 1], selectedTile;
            let finalTempBoard = null;

            while (!solvable && attempts < 50) {
                selectedTile = TARGET_TILES[Math.floor(Math.random() * TARGET_TILES.length)];
                currentLayoutConfig = {};
                for(let i=0; i<9; i++) currentLayoutConfig[i] = { type: 'EMPTY' };
                selectedShape.active.forEach(pos => { 
                    currentLayoutConfig[pos-1] = { type: 'SOLVE' }; 
                });
                selectedShape.targets.forEach((pos, idx) => {
                    if (idx < selectedTile.blocks.length) {
                        const b = selectedTile.blocks[idx];
                        currentLayoutConfig[pos-1] = { type: 'FIXED', id: b.id, face: b.f };
                    } else { currentLayoutConfig[pos-1] = { type: 'SOLVE' }; }
                });
                
                let tempBoard = Array(9).fill(null);
                let tempUsed = new Set();
                let emptySpecs = Array(9).fill(null);
                for(let i=0; i<9; i++) {
                    if (currentLayoutConfig[i].type === 'FIXED') {
                        tempBoard[i] = { id: currentLayoutConfig[i].id, face: currentLayoutConfig[i].face, rot: 0, isFixed: true };
                        tempUsed.add(currentLayoutConfig[i].id);
                    }
                }
                if (solveSmart(0, tempBoard, tempUsed, emptySpecs)) {
                    solvable = true; finalTempBoard = tempBoard;
                }
                attempts++;
            }
            if (!solvable) return alert("ç”Ÿæˆå¤±æ•—");

            absoluteSolution = finalTempBoard.map(b => b ? {...b} : null);

            // åŸ·è¡Œé—œå¡ç‹€æ…‹åˆå§‹åŒ– (æŠ½å–ç‚ºç¨ç«‹å‡½æ•¸ä»¥ä¾›ç”Ÿéˆç²¾éˆé‡ç½®ä½¿ç”¨)
            initializeRoundState();
            
            // ç”Ÿéˆç²¾éˆï¼šæ¯é—œ 1 æ¬¡
            natureUses = 1;

            let levelInfo = $('level-info');
            originalLevelInfoText = `${selectedShape.name} (é€šé—œ+${config.base}åˆ† | é€Ÿé€š+${config.bonus}åˆ†)`;
            levelInfo.innerText = originalLevelInfoText;
            levelInfo.style.color = "#f1c40f"; 
            
            startTimer(config.time); roundStartTime = Date.now();
            renderGameGrid();
            renderActionBar();
        }

        function initializeRoundState() {
            let neededIDs = new Set();
            solutionFixedRotations.clear();
            frozenBlocks.clear();
            shadowTargetIndices = [];
            shadowEaten = {};
            shadowTurn = 0;
            permanentlyRemovedBlocks.clear(); 
            
            // å°‡ç›¤é¢æ¢å¾©æˆåˆå§‹é è¨­ (æ’é™¤å¤§åœ°ç²¾éˆé€ æˆçš„ TYPE = EMPTY ç ´å£)
            // éœ€è¦ä¾è³´ absoluteSolution ä¾†é‚„åŸ currentLayoutConfig çš„ type
            for(let i=0; i<9; i++) {
                if(absoluteSolution[i]) {
                    if (absoluteSolution[i].isFixed) {
                        currentLayoutConfig[i].type = 'FIXED';
                    } else {
                        currentLayoutConfig[i].type = 'SOLVE';
                    }
                } else {
                    currentLayoutConfig[i].type = 'EMPTY';
                }
            }
            
            for(let i=0; i<9; i++) {
                if (absoluteSolution[i]) {
                    neededIDs.add(absoluteSolution[i].id);
                    if (currentLayoutConfig[i].type === 'FIXED') {
                        solutionFixedRotations.set(i, absoluteSolution[i].rot);
                        shadowTargetIndices.push(i);
                    }
                }
            }
            unneededBlocks = [1,2,3,4,5,6,7,8,9].filter(id => !neededIDs.has(id));
            unneededBlocks.sort(() => Math.random() - 0.5); 
            
            Object.values(SPRITES).forEach(s => {
                s.timer = s.cd;
                s.paused = false;
            });

            userBoard = Array(9).fill(null);
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') {
                    userBoard[i] = { id: currentLayoutConfig[i].id, face: currentLayoutConfig[i].face, rot: 0, isFixed: true };
                }
            }
            activeHint = null;
        }

        // --- æŠ€èƒ½åˆ—æ¸²æŸ“èˆ‡äº’å‹• ---
        function renderActionBar() {
            let bar = $('sprite-action-bar');
            bar.innerHTML = '';
            
            let activeSprites = Object.values(SPRITES).filter(s => s.active);
            if (!isHolyEnabled && !isEarthEnabled && !isNatureEnabled && activeSprites.length === 0) {
                bar.style.display = 'none'; return;
            }
            bar.style.display = 'flex'; 

            if (isHolyEnabled) {
                let holyBtn = document.createElement('div');
                holyBtn.id = 'btn-sp-holy';
                holyBtn.className = `sprite-btn theme-holy ${holyLightUses <= 0 ? 'disabled' : ''}`;
                holyBtn.innerHTML = `âœ¨è–å…‰ <span>${holyLightUses}æ¬¡</span>`;
                holyBtn.onclick = activateHolyLight;
                bar.appendChild(holyBtn);
            }

            if (isEarthEnabled) {
                let earthBtn = document.createElement('div');
                earthBtn.id = 'btn-sp-earth';
                earthBtn.className = `sprite-btn theme-earth ${earthUses <= 0 ? 'disabled' : ''}`;
                earthBtn.innerHTML = `ğŸŸ¤å¤§åœ° <span>${earthUses}æ¬¡</span>`;
                earthBtn.onclick = activateEarthSprite;
                bar.appendChild(earthBtn);
            }

            if (isNatureEnabled) {
                let natureBtn = document.createElement('div');
                natureBtn.id = 'btn-sp-nature';
                natureBtn.className = `sprite-btn theme-nature ${natureUses <= 0 ? 'disabled' : ''}`;
                natureBtn.innerHTML = `ğŸŸ¢ç”Ÿéˆ <span>${natureUses}æ¬¡</span>`;
                natureBtn.onclick = activateNatureSprite;
                bar.appendChild(natureBtn);
            }

            activeSprites.forEach(s => {
                let btn = document.createElement('div');
                btn.id = `btn-sp-${s.id}`;
                btn.className = `sprite-btn ${s.theme} ${s.paused ? 'disabled' : ''}`;
                // ç°¡åŒ–è¢«å‹•ç²¾éˆæŒ‰éˆ•æ–‡å­—ä»¥é©æ‡‰ç‰ˆé¢
                let shortName = s.name.substring(0, 4);
                btn.innerHTML = `${shortName} <span>${s.timer}s</span>`;
                btn.onclick = () => toggleSprite(s.id);
                bar.appendChild(btn);
            });
        }

        function updateSpriteButton(id) {
            let btn = $(`btn-sp-${id}`);
            if(btn) {
                let s = SPRITES[id];
                btn.querySelector('span').innerText = `${s.timer}s`;
                if(s.paused) btn.classList.add('disabled');
                else btn.classList.remove('disabled');
            }
        }

        function toggleSprite(id) {
            if(isRoundWon || isSolverUsed) return;
            SPRITES[id].paused = !SPRITES[id].paused;
            updateSpriteButton(id);
            playSound('action');
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            timeLeft = currentTotalTime = seconds; 
            updateTimerDisplay(); updateTimeBar(); 
            timerInterval = setInterval(() => {
                timeLeft--; updateTimerDisplay(); updateTimeBar();
                if (timeLeft <= 10) $('timer-disp').classList.add('urgent');
                
                ['shadow', 'ice', 'fire'].forEach(key => {
                    let sp = SPRITES[key];
                    if (sp.active && !sp.paused && !isRoundWon && !isSolverUsed) {
                        sp.timer--;
                        updateSpriteButton(key);
                        if (sp.timer <= 0) {
                            executeSpriteLogic(key);
                            sp.timer = sp.cd;
                            updateSpriteButton(key);
                        }
                    }
                });

                if (timeLeft <= 0) { clearInterval(timerInterval); handleTimeOut(); }
            }, 1000);
        }

        function executeSpriteLogic(key) {
            let levelInfo = $('level-info');
            let btn = $(`btn-sp-${key}`);
            if(btn) {
                btn.classList.add('flash-intense');
                setTimeout(() => btn.classList.remove('flash-intense'), 1500);
            }

            if (key === 'fire') {
                if (unneededBlocks.length > 0) {
                    let removedID = unneededBlocks.pop();
                    permanentlyRemovedBlocks.add(removedID);
                    let removedFromBoard = false;
                    for (let i = 0; i < 9; i++) {
                        if (userBoard[i] && userBoard[i].id === removedID && !userBoard[i].isFixed) {
                            let cell = $('grid-container').children[i+1]; 
                            if(cell) cell.classList.add('fire-flash');
                            setTimeout(() => {
                                userBoard[i] = null;
                                if (activeHint && activeHint.index === i) activeHint = null;
                                renderGameGrid();
                            }, 500);
                            removedFromBoard = true;
                        }
                    }
                    if (!removedFromBoard) renderGameGrid(); 
                    playSound('fire'); 
                    levelInfo.innerText = removedFromBoard ? `ğŸ”¥ ç«ç„°ç²¾éˆï¼šç‡’æ¯€å ´ä¸Š 1 å€‹å¹²æ“¾æ–¹å¡Šï¼` : `ğŸ”¥ ç«ç„°ç²¾éˆï¼šå¾æ¸…å–®ç‡’æ¯€ 1 å€‹å¹²æ“¾æ–¹å¡Šï¼`;
                    levelInfo.style.color = "#ff7675";
                    if ($('picker-modal').style.display === 'flex') renderPickerGrid();
                    
                } else {
                    let { wrongIndex } = getSmartSolution(userBoard);
                    if (wrongIndex !== -1 && userBoard[wrongIndex] && !userBoard[wrongIndex].isFixed) {
                        let cell = $('grid-container').children[wrongIndex + 1];
                        if(cell) cell.classList.add('fire-flash');
                        setTimeout(() => {
                            userBoard[wrongIndex] = null; 
                            if (activeHint && activeHint.index === wrongIndex) activeHint = null;
                            renderGameGrid();
                        }, 500);
                        playSound('fire');
                        levelInfo.innerText = `ğŸ”¥ ç«ç„°ç²¾éˆï¼šç‡’æ¯€å ´ä¸Š 1 å€‹éŒ¯èª¤æ–¹å¡Šä¸¦é€€å›æ¸…å–®ï¼`;
                        levelInfo.style.color = "#ff7675";
                        if ($('picker-modal').style.display === 'flex') renderPickerGrid();
                    } else {
                        levelInfo.innerText = `ğŸ”¥ ç«ç„°ç²¾éˆï¼šå ´ä¸Šç„¡éŒ¯èª¤æ–¹å¡Šï¼Œå·¡é‚ä¸­ï¼`;
                        levelInfo.style.color = "#ff7675";
                    }
                 }

            } else if (key === 'ice') {
                let unfrozenFixed = [];
                for(let i=0; i<9; i++) {
                    if (currentLayoutConfig[i].type === 'FIXED' && !frozenBlocks.has(i)) {
                        unfrozenFixed.push(i);
                    }
                }
                
                if (unfrozenFixed.length > 0) {
                    let targetIdx = -1;
                    for (let idx of unfrozenFixed) {
                        if (userBoard[idx].rot !== solutionFixedRotations.get(idx)) { targetIdx = idx; break; }
                    }
                    if (targetIdx === -1) targetIdx = unfrozenFixed[Math.floor(Math.random() * unfrozenFixed.length)];
                    
                    userBoard[targetIdx].rot = solutionFixedRotations.get(targetIdx);
                    frozenBlocks.add(targetIdx);
                    renderGameGrid();
                    playSound('ice'); 
                    levelInfo.innerText = `â„ï¸ å†°é›ªç²¾éˆï¼šå·²ç‚ºæ‚¨æ ¡æ­£ä¸¦å‡çµ 1 å€‹æŒ‡å®šæ–¹å¡Šï¼`;
                    levelInfo.style.color = "#74b9ff";
                    
                } else {
                    let correctUserIndices = [];
                    for (let i = 0; i < 9; i++) {
                        if (userBoard[i] && !userBoard[i].isFixed && !frozenBlocks.has(i) && currentLayoutConfig[i].type !== 'EMPTY') {
                            let absBlock = absoluteSolution[i];
                            if (absBlock && userBoard[i].id === absBlock.id && userBoard[i].face === absBlock.face && userBoard[i].rot === absBlock.rot) {
                                correctUserIndices.push(i);
                            }
                        }
                    }
                    
                    if (correctUserIndices.length > 0) {
                        let targetIdx = correctUserIndices[Math.floor(Math.random() * correctUserIndices.length)];
                        frozenBlocks.add(targetIdx);
                        renderGameGrid();
                        playSound('ice');
                        levelInfo.innerText = `â„ï¸ å†°é›ªç²¾éˆï¼šç¢ºèª 1 å€‹è‡ªé¸æ–¹å¡Šæ­£ç¢ºï¼Œå·²å‡çµä¿è­·ï¼`;
                        levelInfo.style.color = "#74b9ff";
                    } else {
                        levelInfo.innerText = `â„ï¸ å†°é›ªç²¾éˆï¼šç›®å‰å ´ä¸Šç„¡å®Œå…¨æ­£ç¢ºçš„æ–°æ–¹å¡Šï¼`;
                        levelInfo.style.color = "#74b9ff";
                    }
                }

            } else if (key === 'shadow') {
                let validTargets = shadowTargetIndices.filter(idx => !shadowEaten[idx] || shadowEaten[idx].length < 4);
                if (validTargets.length > 0) {
                    let targetIdx = validTargets[shadowTurn % validTargets.length];
                    if (!shadowEaten[targetIdx]) shadowEaten[targetIdx] = [];
                    
                    let available = [0,1,2,3].filter(c => !shadowEaten[targetIdx].includes(c));
                    if(available.length > 0) {
                        let c = available[Math.floor(Math.random() * available.length)];
                        shadowEaten[targetIdx].push(c);
                    }
                    
                    shadowTurn++;
                    renderGameGrid();
                    playSound('shadow'); 
                    
                    let eatenCount = shadowEaten[targetIdx].length;
                    levelInfo.innerText = eatenCount === 4 
                        ? `ğŸŸ£ é—‡å½±ç²¾éˆï¼šæ•´å¡Šé­”çŸ³å·²è¢«å®Œå…¨ä¾µè•ç‚ºç™¾æ­ç©ºæ´ï¼`
                        : `ğŸŸ£ é—‡å½±ç²¾éˆï¼šä¾µè•æŒ‡å®šé­”çŸ³ (${eatenCount}/4)ï¼`;
                    levelInfo.style.color = "#9b59b6";
                }
            }

            setTimeout(() => {
                if(!isRoundWon && !isSolverUsed && levelInfo.innerText.includes("ç²¾éˆ")) {
                    levelInfo.innerText = originalLevelInfoText;
                    levelInfo.style.color = "#f1c40f"; 
                }
            }, 4000);
        }

        // âœ¨ è–å…‰ç²¾éˆï¼šä¸»å‹•æŠ€
        function activateHolyLight() {
            if (isRoundWon || activeHint) return; 

            let placedCount = 0, solveCount = 0;
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'SOLVE') {
                    solveCount++;
                    if (userBoard[i]) placedCount++;
                }
            }

            let { solution, wrongIndex } = getSmartSolution(userBoard);

            if (wrongIndex === -1 && placedCount === solveCount) {
                alert("âœ¨ æ–¹å¡Šå…¨æ•¸æ­¸ä½ï¼Œè©¦è‘—è½‰è½‰çœ‹å§ï¼"); return; 
            }
            if (holyLightUses <= 0) {
                alert("è–å…‰ç²¾éˆçš„æ³•åŠ›å·²è€—ç›¡ï¼"); return;
            }
            if (!solution || !solution.every((b, i) => currentLayoutConfig[i].type === 'EMPTY' || b !== null)) {
               alert("ç„¡æ³•ç”ŸæˆæŒ‡å¼•ï¼Œè«‹ç¢ºèªç›¤é¢ç‹€æ…‹ã€‚"); return;
            }

            let targetIdx = -1;
            if (wrongIndex !== -1) { targetIdx = wrongIndex; } 
            else {
                for (let i = 0; i < 9; i++) {
                    if (currentLayoutConfig[i].type === 'SOLVE' && !userBoard[i]) { targetIdx = i; break; }
                }
            }

            if (targetIdx !== -1) {
                let correctBlock = solution[targetIdx];
                holyLightUses--; 
                activeHint = { index: targetIdx, id: correctBlock.id, face: correctBlock.face, rot: 0 };
                
                if (audioCtx.state === 'suspended') audioCtx.resume();
                playNote(880, audioCtx.currentTime, 0.1); 
                playNote(1760, audioCtx.currentTime + 0.1, 0.3);

                let levelInfo = $('level-info');
                levelInfo.innerText = `âœ¨ è–å…‰ç²¾éˆï¼šç¥è–ä¹‹å…‰ç…§äº®äº†æ­£ç¢ºçš„æ–¹å¡Šï¼`;
                levelInfo.style.color = "#f1c40f";

                let btnHoly = $('btn-sp-holy');
                if (btnHoly) {
                    btnHoly.classList.add('flash-intense');
                    setTimeout(() => btnHoly.classList.remove('flash-intense'), 1500);
                    btnHoly.innerHTML = `âœ¨è–å…‰ <span>${holyLightUses}æ¬¡</span>`;
                    if (holyLightUses <= 0) btnHoly.classList.add('disabled');
                }
                renderGameGrid(); 
            }
        }

        // ğŸŸ¤ å¤§åœ°ç²¾éˆï¼šä¸»å‹•æŠ€ 
        function activateEarthSprite() {
            if (isRoundWon) return; 

            let emptySolveSlots = [];
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'SOLVE' && userBoard[i] === null) {
                    emptySolveSlots.push(i);
                }
            }

            if (earthUses <= 0) {
                alert("å¤§åœ°ç²¾éˆçš„æ³•åŠ›å·²è€—ç›¡ï¼"); return;
            }
            if (emptySolveSlots.length === 0) {
                alert("ğŸŸ¤ ç›®å‰æ²’æœ‰å¯ä»¥æ¶ˆé™¤çš„ç©ºæ ¼ï¼(è‹¥å¡é—œè«‹å…ˆæ‹”é™¤éŒ¯çš„æ–¹å¡Š)"); return;
            }

            let targetIdx = emptySolveSlots[Math.floor(Math.random() * emptySolveSlots.length)];
            
            earthUses--;
            currentLayoutConfig[targetIdx].type = 'EMPTY'; 
            userBoard[targetIdx] = null; 
            
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playNote(300, audioCtx.currentTime, 0.1); 
            playNote(150, audioCtx.currentTime + 0.1, 0.3);

            let levelInfo = $('level-info');
            levelInfo.innerText = `ğŸŸ¤ å¤§åœ°ç²¾éˆï¼šæ¿å¡Šå´©å¡Œï¼å·²ç‚ºæ‚¨æ¶ˆé™¤ 1 å€‹ç©ºæ ¼é™ä½é›£åº¦ï¼`;
            levelInfo.style.color = "#27ae60";

            let btnEarth = $('btn-sp-earth');
            if (btnEarth) {
                btnEarth.classList.add('flash-intense');
                setTimeout(() => btnEarth.classList.remove('flash-intense'), 1500);
                btnEarth.innerHTML = `ğŸŸ¤å¤§åœ° <span>${earthUses}æ¬¡</span>`;
                if (earthUses <= 0) btnEarth.classList.add('disabled');
            }
            
            renderGameGrid(); 
        }

        // ğŸŸ¢ ç”Ÿéˆç²¾éˆï¼šä¸»å‹•æŠ€ (é‡ç½®é—œå¡)
        function activateNatureSprite() {
            if (isRoundWon || isSolverUsed) return;
            
            if (natureUses <= 0) {
                alert("ç”Ÿéˆç²¾éˆçš„æ³•åŠ›å·²è€—ç›¡ï¼æ¯é—œåƒ…èƒ½é‡ç½® 1 æ¬¡ã€‚"); return;
            }

            if (confirm("ğŸŸ¢ ç¢ºå®šè¦ç™¼å‹•ç”Ÿéˆç²¾éˆå—ï¼Ÿ\n\næœ¬é—œæ™‚é–“èˆ‡ç›¤é¢å°‡å®Œå…¨é‡ç½®ï¼\nä½†è–å…‰èˆ‡å¤§åœ°çš„ä½¿ç”¨æ¬¡æ•¸ã€ä¸æœƒã€‘å¾©åŸã€‚")) {
                natureUses--;
                
                // æ’­æ”¾ç”Ÿæ©Ÿç›ç„¶çš„éŸ³æ•ˆ
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const now = audioCtx.currentTime;
                playNote(440, now, 0.1); 
                playNote(554, now + 0.1, 0.1); 
                playNote(659, now + 0.2, 0.2); 

                // é‡æ–°åˆå§‹åŒ–æœ¬é—œç‹€æ…‹ (æ¸…ç©ºè¢«å‹•ç²¾éˆèˆ‡ç›¤é¢)
                initializeRoundState();
                
                // æ™‚é–“èˆ‡è¨ˆæ™‚å™¨é‡ç½®
                roundStartTime = Date.now();
                startTimer(currentTotalTime);
                
                let levelInfo = $('level-info');
                levelInfo.innerText = `ğŸŸ¢ ç”Ÿéˆç²¾éˆï¼šæ™‚å…‰é€†è½‰ï¼é—œå¡å·²é‡ç½®ï¼`;
                levelInfo.style.color = "#2ecc71";

                let btnNature = $('btn-sp-nature');
                if (btnNature) {
                    btnNature.classList.add('flash-intense');
                    setTimeout(() => btnNature.classList.remove('flash-intense'), 1500);
                    btnNature.innerHTML = `ğŸŸ¢ç”Ÿéˆ <span>${natureUses}æ¬¡</span>`;
                    btnNature.classList.add('disabled');
                }
                
                // é‡æ–°æ¸²æŸ“ Action Bar ä»¥ç¢ºä¿è¢«å‹•ç²¾éˆæŒ‰éˆ•ç‹€æ…‹ä¹Ÿæ›´æ–°ç‚ºæ­£å¸¸
                renderActionBar();
                renderGameGrid();
            }
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            $('timer-disp').innerText = `${m}:${s}`;
        }

        function updateTimeBar() {
            const bar = $('time-bar-fill'), pct = (timeLeft / currentTotalTime) * 100;
            bar.style.width = `${pct}%`;
            bar.classList.remove('state-purple', 'state-blue', 'state-red');
            bar.classList.add(pct > 70 ? 'state-purple' : pct < 30 ? 'state-red' : 'state-blue');
        }

        function handleTimeOut() {
            if (isRoundWon) return;
            calculateTimeSpent(); forceSolve(false);
            let btnSolve = $('btn-solve'), levelInfo = $('level-info');
            btnSolve.innerText = "âŒ› å¤±æ•—"; btnSolve.className = "small-action-btn failed";
            $('btn-reset').style.display = 'none'; $('sprite-action-bar').style.display = 'none';
            levelInfo.innerText = "æ™‚é–“è€—ç›¡ï¼Œå…¬å¸ƒè§£ç­”"; levelInfo.style.color = "#e74c3c";
        }

        function calculateTimeSpent() {
            let spent = Math.floor((Date.now() - roundStartTime) / 1000);
            return totalTimeSpent += spent, spent;
        }

        function nextLevel() {
            clearInterval(timerInterval);
            const spent = calculateTimeSpent(); 
            if (!isSolverUsed) {
                const config = ROUND_SETTINGS[currentRound];
                totalScore += config.base + (spent <= 60 ? config.bonus : 0);
            }
            updateHUD(); currentRound++;
            if (currentRound > 6) showEndScreen(); else loadRound(currentRound);
        }

        function updateHUD() {
            $('round-disp').innerText = `${currentRound} / 6`;
            $('score-disp').innerText = totalScore;
        }

        function resetLevel() {
            if (isRoundWon || isSolverUsed) return;
            playSound('reset');
            activeHint = null; 
            for (let i = 0; i < 9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') {
                    userBoard[i].rot = frozenBlocks.has(i) ? solutionFixedRotations.get(i) : 0; 
                    userBoard[i].face = currentLayoutConfig[i].face; 
                } else { userBoard[i] = null; }
            }
            renderGameGrid(); lastValidLineCount = 0;
        }

        // --- æ’è¡Œæ¦œ ---
        function saveRecord(now) {
            // æ’è¡Œæ¦œæ’åºï¼š1. ç¸½åˆ†é«˜  2. ç²¾éˆæ”œå¸¶æ•¸å°‘  3. è€—æ™‚å°‘
            const record = { 
                name: playerName, 
                score: totalScore, 
                spriteCount: selectedSpriteCount, 
                time: totalTimeSpent, 
                lvl: selectedLevel, 
                date: now 
            };
            let lb = JSON.parse(localStorage.getItem('coludoku_lb_v12') || "[]");
            lb.push(record);
            
            // æ’åºé‚è¼¯å¯¦ä½œ
            lb.sort((a,b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (a.spriteCount !== b.spriteCount) return a.spriteCount - b.spriteCount;
                return a.time - b.time;
            });

            if (lb.length > 500) lb = lb.slice(0, 500);
            localStorage.setItem('coludoku_lb_v12', JSON.stringify(lb));
            return lb;
        }

        function getRankTitle(score) {
            let maxS = 0; for(let i=1; i<=6; i++) maxS += (ROUND_SETTINGS[i].base + ROUND_SETTINGS[i].bonus);
            let pct = score / maxS;
            return pct===1 ? "å‚³å¥‡" : pct>=0.9 ? "è‡³å°Š" : pct>=0.75 ? "é«˜ç´š" : pct>=0.6 ? "åˆç´š" : "è¦‹ç¿’";
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2,'0'), s = (sec % 60).toString().padStart(2,'0');
            return `${m}:${s}`;
        }

        function showEndScreen() {
            $('end-modal').style.display = 'flex';
            let maxScore = 0; for(let i=1; i<=6; i++) maxScore += (ROUND_SETTINGS[i].base + ROUND_SETTINGS[i].bonus);

            $('end-player-name').innerText = `${playerName}`;
            $('end-title-desc').innerText = `âœ¨ æ­å–œç²å¾—ã€${getRankTitle(totalScore)}å°å°å¸«ã€‘ç¨±è™Ÿï¼ (æŒ‘æˆ° L${selectedLevel})`;
            
            $('end-score').innerText = `${totalScore}`;
            $('end-hints').innerText = `${selectedSpriteCount}`; // é¡¯ç¤ºæ”œå¸¶çš„ç²¾éˆæ•¸
            $('end-time').innerText = formatTime(totalTimeSpent);
            
            const now = Date.now(), lbData = saveRecord(now);
            const myRankIndex = lbData.findIndex(r => r.date === now), totalPlayers = lbData.length;
            let beatenPct = totalPlayers > 1 ? Math.floor(((totalPlayers - myRankIndex - 1) / totalPlayers) * 100) : 100;
            if (totalPlayers > 1 && myRankIndex === 0) beatenPct = 99;
            $('end-percentile').innerText = `ğŸ† æ“Šæ•—äº†å…¨æœ ${beatenPct}% çš„ç©å®¶`;

            const container = $('level-boards');
            container.innerHTML = "";
            for (let i = 1; i <= 6; i++) {
                let lvlData = lbData.filter(r => r.lvl === i).slice(0, 5);
                let boardHtml = `<div class="level-board"><div class="level-board-title">LEVEL ${i} æ’è¡Œæ¦œ</div><table class="lb-mini-table">`;
                if (lvlData.length === 0) boardHtml += `<tr><td style="text-align:center; color:#999; padding:15px 0;">å°šç„¡ç´€éŒ„</td></tr>`;
                else lvlData.forEach((r, idx) => { 
                    boardHtml += `<tr><td class="rank">${idx + 1}</td><td class="name">${r.name}</td><td class="score-time">${r.score}åˆ†/ğŸ§š${r.spriteCount}/ ${formatTime(r.time)}</td></tr>`; 
                });
                boardHtml += `</table></div>`; container.innerHTML += boardHtml;
            }
        }

        // --- éŠæˆ²æ“ä½œ ---
        function renderGameGrid() {
            const container = $('grid-container');
            container.innerHTML = '';
            const glowLayer = document.createElement('div');
            glowLayer.className = 'glow-overlay'; glowLayer.id = 'glow-layer';
            container.appendChild(glowLayer);

            for(let i=0; i<9; i++) {
                const config = currentLayoutConfig[i], block = userBoard[i], div = document.createElement('div');
                if (config.type === 'EMPTY') {
                    div.className = 'block empty-slot'; div.style.visibility = 'hidden';
                } else {
                    div.className = 'block';
                    if (block) {
                        div.classList.add(block.isFixed ? 'fixed' : 'user-placed');
                        if (frozenBlocks.has(i)) div.classList.add('frozen');

                        div.innerHTML = `<div class="block-content" style="position:absolute; width:100%; height:100%; transform: rotate(${block.rot * 90}deg); display:flex; justify-content:center; align-items:center;">
                            <img src="images/block_${block.face}-0${block.id}.png" class="block-image" draggable="false">
                        </div>`;
                        
                        if (shadowEaten[i]) {
                            const contentDiv = div.querySelector('.block-content');
                            shadowEaten[i].forEach(cornerIdx => {
                                const voidEl = document.createElement('div');
                                voidEl.className = `void-erosion corner-${cornerIdx}`;
                                contentDiv.appendChild(voidEl);
                            });
                        }
                        
                        if (activeHint && activeHint.index === i) {
                            div.innerHTML += `<div style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.3); z-index:10; display:flex; justify-content:center; align-items:center; border-radius:6px; border: 2px solid #e74c3c; box-shadow: inset 0 0 15px rgba(231, 76, 60, 0.8); pointer-events:none; animation: pulseRed 1.5s infinite;">
                                <img src="images/block_${activeHint.face}-0${activeHint.id}.png" style="width:80%; height:80%; opacity:0.9; transform: rotate(0deg); filter: drop-shadow(0 0 5px #f1c40f);">
                            </div>`;
                        }

                        const edgeZone = document.createElement('div');
                        edgeZone.className = 'zone-edge'; edgeZone.onclick = (e) => { e.stopPropagation(); rotateBlock(i); };
                        div.appendChild(edgeZone);
                        
                        if (!block.isFixed) {
                            const centerZone = document.createElement('div');
                            centerZone.className = 'zone-center'; centerZone.onclick = (e) => { e.stopPropagation(); flipBlock(i); };
                            const startLongPress = () => { longPressTimer = setTimeout(() => clearBlock(i), 600); }, cancelLongPress = () => clearTimeout(longPressTimer);
                            centerZone.addEventListener('mousedown', startLongPress); centerZone.addEventListener('touchstart', startLongPress);
                            centerZone.addEventListener('mouseup', cancelLongPress); centerZone.addEventListener('touchend', cancelLongPress);
                            centerZone.addEventListener('mouseleave', cancelLongPress);
                            div.appendChild(centerZone);
                        }
                    } else {
                        div.className = 'empty-slot'; 
                        if (activeHint && activeHint.index === i) {
                            div.innerHTML = `<img src="images/block_${activeHint.face}-0${activeHint.id}.png" style="width:80%; height:80%; opacity:0.4; transform: rotate(0deg); pointer-events:none;">`;
                            div.style.borderColor = '#f39c12';
                            div.style.boxShadow = 'inset 0 0 15px rgba(243, 156, 18, 0.4)';
                        } else {
                            div.innerHTML = '+'; div.style.borderColor = ''; div.style.boxShadow = '';
                        }
                        if (introTutPhase === 1 && config.type === 'SOLVE') div.classList.add('tut-highlight-blue');
                        div.onclick = () => openPicker(i);
                    }
                }
                container.appendChild(div);
            }
            updateGlowsAndWin();
        }

        function rotateBlock(index) { 
            if (userBoard[index] && !isRoundWon && !frozenBlocks.has(index)) { 
                userBoard[index].rot = (userBoard[index].rot + 1) % 4; 
                if (activeHint && activeHint.index === index) activeHint = null; 
                playSound('action'); renderGameGrid(); 
            } 
        }

        function flipBlock(index) { 
            if (userBoard[index] && !userBoard[index].isFixed && !isRoundWon) { 
                userBoard[index].face = userBoard[index].face === 'B' ? 'W' : 'B'; 
                if (activeHint && activeHint.index === index) activeHint = null; 
                playSound('action'); renderGameGrid(); 
            } 
        }

        function clearBlock(index) { 
            if (isRoundWon) return; 
            if (userBoard[index] && userBoard[index].isFixed) return;
            userBoard[index] = null; 
            if (activeHint && activeHint.index === index) activeHint = null;
            playSound('action'); 
            if (introTutPhase === 3) setIntroPhase(1);            
            renderGameGrid(); 
        }
        
        function getAvailableBlocks() { 
            const used = new Set(); 
            userBoard.forEach((b, i) => { if(b && currentLayoutConfig[i].type !== 'EMPTY') used.add(b.id); }); 
            return [1,2,3,4,5,6,7,8,9].filter(id => !used.has(id) && !permanentlyRemovedBlocks.has(id)); 
        }

        function openPicker(index) { 
            if (isRoundWon) return; 
            if (introTutPhase === 1) {
                if (currentLayoutConfig[index].type !== 'SOLVE') return; 
                setIntroPhase(2);
            } else if (introTutPhase > 0) return; 
            
            if (activeHint && activeHint.index === index) { activeHint = null; renderGameGrid(); }
            pickingSlot = index; pickerFace = 'B'; renderPickerGrid(); $('picker-modal').style.display = 'flex'; 
        }

        function togglePickerFace() { pickerFace = (pickerFace === 'B') ? 'W' : 'B'; renderPickerGrid(); }

        function renderPickerGrid() {
            const grid = $('picker-grid');
            $('picker-title').innerText = `é¸æ“‡é­”çŸ³ (${pickerFace}é¢)`; grid.innerHTML = '';
            getAvailableBlocks().forEach(id => {
                const div = document.createElement('div'); div.className = 'picker-item';
                if (introTutPhase === 2 && id === 2) div.classList.add('tut-highlight-yellow');
                
                div.innerHTML = `<img src="images/block_${pickerFace}-0${id}.png">`;
                div.onclick = () => { 
                    if (introTutPhase === 2) { if (id !== 2) return; setIntroPhase(3); }
                    if (activeHint && activeHint.index === pickingSlot) activeHint = null; 
                    userBoard[pickingSlot] = { id: id, face: pickerFace, rot: 0, isFixed: false }; 
                    playSound('action'); closePicker(); renderGameGrid(); 
                };
                grid.appendChild(div);
            });
        }
        function closePicker() { 
            $('picker-modal').style.display = 'none'; 
            if (introTutPhase === 2 && !userBoard[pickingSlot]) setIntroPhase(1); 
        }

        function getRotatedMatrix(m, times) {
            for (let t = 0; t < times; t++) m = [[m[1][0], m[0][0]], [m[1][1], m[0][1]]];
            return m;
        }

        function getFullGrid(boardState = userBoard) {
            let fullGrid = Array(6).fill().map(() => Array(6).fill(0));
            for(let i=0; i<9; i++) {
                if(!boardState[i] || currentLayoutConfig[i].type === 'EMPTY') continue;
                let b = boardState[i], r = Math.floor(i / 3) * 2, c = (i % 3) * 2;
                
                let baseMatrix = [
                    [BLOCKS[b.id][b.face][0][0], BLOCKS[b.id][b.face][0][1]],
                    [BLOCKS[b.id][b.face][1][0], BLOCKS[b.id][b.face][1][1]]
                ];
                
                if (shadowEaten[i]) {
                    if (shadowEaten[i].includes(0)) baseMatrix[0][0] = 0;
                    if (shadowEaten[i].includes(1)) baseMatrix[0][1] = 0;
                    if (shadowEaten[i].includes(2)) baseMatrix[1][0] = 0;
                    if (shadowEaten[i].includes(3)) baseMatrix[1][1] = 0;
                }

                let matrix = getRotatedMatrix(baseMatrix, b.rot);
                
                fullGrid[r][c] = matrix[0][0]; fullGrid[r][c+1] = matrix[0][1];
                fullGrid[r+1][c] = matrix[1][0]; fullGrid[r+1][c+1] = matrix[1][1];
            } 
            return fullGrid;
        }

        function isLineValid(grid, idx, isRow) {
            let values = [];
            for (let k = 0; k < 6; k++) { const val = isRow ? grid[idx][k] : grid[k][idx]; if (val !== 0) values.push(val); }
            return values.length > 0 && new Set(values).size === values.length;
        }

        function isValid(boardState) {
            let seenIDs = new Set();
            for (let i = 0; i < 9; i++) {
                if (boardState[i] && currentLayoutConfig[i].type !== 'EMPTY') {
                    if (seenIDs.has(boardState[i].id)) return false;
                    seenIDs.add(boardState[i].id);
                }
            }

            let grid = getFullGrid(boardState);
            for (let i = 0; i < 6; i++) {
                let rSet = new Set(), cSet = new Set();
                for (let j = 0; j < 6; j++) {
                    let rVal = grid[i][j], cVal = grid[j][i];
                    if (rVal !== 0) { if (rSet.has(rVal)) return false; rSet.add(rVal); }
                    if (cVal !== 0) { if (cSet.has(cVal)) return false; cSet.add(cVal); }
                }
            } return true;
        }

        function updateGlowsAndWin() {
            const glowLayer = $('glow-layer'), grid = getFullGrid(); glowLayer.innerHTML = '';
            let currentValidLineCount = 0;
            
            for (let r = 0; r < 3; r++) {
                let cnt = (userBoard[r*3] && currentLayoutConfig[r*3].type !== 'EMPTY' ?1:0) + 
                          (userBoard[r*3+1] && currentLayoutConfig[r*3+1].type !== 'EMPTY'?1:0) + 
                          (userBoard[r*3+2] && currentLayoutConfig[r*3+2].type !== 'EMPTY'?1:0);
                if (cnt > 1 && isLineValid(grid, r*2, true) && isLineValid(grid, r*2+1, true)) {
                    const glow = document.createElement('div'); glow.className = 'glow-bar glow-row'; glow.style.top = (r * 33.33 + 0.5) + '%';
                    glowLayer.appendChild(glow); currentValidLineCount++;
                }
            }
            for (let c = 0; c < 3; c++) {
                let cnt = (userBoard[c] && currentLayoutConfig[c].type !== 'EMPTY'?1:0) + 
                          (userBoard[c+3] && currentLayoutConfig[c+3].type !== 'EMPTY'?1:0) + 
                          (userBoard[c+6] && currentLayoutConfig[c+6].type !== 'EMPTY'?1:0);
                if (cnt > 1 && isLineValid(grid, c*2, false) && isLineValid(grid, c*2+1, false)) {
                    const glow = document.createElement('div'); glow.className = 'glow-bar glow-col'; glow.style.left = (c * 33.33 + 0.5) + '%';
                    glowLayer.appendChild(glow); currentValidLineCount++;
                }
            }
            if (currentValidLineCount > lastValidLineCount) playSound('line');
            lastValidLineCount = currentValidLineCount;

            const isFull = userBoard.every((b, i) => currentLayoutConfig[i].type === 'EMPTY' || b !== null);
            if (isFull && isValid(userBoard) && !isRoundWon) {
                isRoundWon = true; 
                clearInterval(timerInterval); 
                
                if (introTutPhase > 0) { setIntroPhase(4); return; }

                playSound('win');
                const spent = Math.floor((Date.now() - roundStartTime) / 1000);
                if (spent <= 60) {
                    setTimeout(() => playSound('bonus'), 800);
                    let levelInfo = $('level-info');
                    levelInfo.innerText += ` â­ é€Ÿé€šé”æˆ (+${ROUND_SETTINGS[currentRound].bonus}åˆ†)`; levelInfo.style.color = "#f1c40f";
                }
                $('grid-container').classList.add('win-glow');
                $('btn-next').style.display = 'inline-block'; 
                $('top-ui-controls').style.display = 'none';
                $('sprite-action-bar').style.display = 'none'; 
            }
        }
        
        function solveSmart(idx, board, usedIDs, userBoardSpecs) {
            if (idx >= 9) return true;
            if (board[idx] !== null) {
                if (!isValid(board)) return false; 
                return solveSmart(idx + 1, board, usedIDs, userBoardSpecs);
            }
            const config = currentLayoutConfig[idx];
            if (config.type === 'EMPTY') return solveSmart(idx + 1, board, usedIDs, userBoardSpecs);
            
            if (config.type === 'FIXED') {
                const { id, face } = config;
                for (let rot = 0; rot < 4; rot++) {
                    board[idx] = { id, face, rot, isFixed: true };
                    if (isValid(board) && solveSmart(idx + 1, board, usedIDs, userBoardSpecs)) return true;
                }
                board[idx] = null; return false;
            }

            if (config.type === 'SOLVE') {
                let spec = userBoardSpecs[idx];
                if (spec) {
                    if (usedIDs.has(spec.id)) return false; 
                    usedIDs.add(spec.id);
                    for (let rot = 0; rot < 4; rot++) {
                        board[idx] = { id: spec.id, face: spec.face, rot: rot, isFixed: false };
                        if (isValid(board) && solveSmart(idx + 1, board, usedIDs, userBoardSpecs)) return true;
                    }
                    board[idx] = null; usedIDs.delete(spec.id); return false;
                } else {
                    for (let id = 1; id <= 9; id++) {
                        if (!usedIDs.has(id)) {
                            usedIDs.add(id);
                            for (let face of ['B', 'W']) {
                                for (let rot = 0; rot < 4; rot++) {
                                    board[idx] = { id, face, rot, isFixed: false };
                                    if (isValid(board) && solveSmart(idx + 1, board, usedIDs, userBoardSpecs)) return true;
                                }
                            }
                            board[idx] = null; usedIDs.delete(id);
                        }
                    }
                    return false; 
                }
            }
            return false;
        }

        function getSmartSolution(board) {
            let validSpecs = Array(9).fill(null);
            let wrongIndex = -1;
            let fixedIDs = new Set();
            for(let k=0; k<9; k++) if (currentLayoutConfig[k].type === 'FIXED') fixedIDs.add(currentLayoutConfig[k].id);

            for (let i = 0; i < 9; i++) {
                let b = board[i];
                if (b && !b.isFixed && currentLayoutConfig[i].type !== 'EMPTY') {
                    validSpecs[i] = { id: b.id, face: b.face };
                    let used = new Set(fixedIDs); let dup = false;
                    for(let k=0; k<=i; k++) {
                        if (validSpecs[k]) {
                            if (used.has(validSpecs[k].id)) dup = true;
                            used.add(validSpecs[k].id);
                        }
                    }
                    if (dup) {
                        if (wrongIndex === -1) wrongIndex = i;
                        validSpecs[i] = null; continue;
                    }
                    let testBoard = Array(9).fill(null);
                    if (!solveSmart(0, testBoard, new Set(fixedIDs), validSpecs)) {
                        if (wrongIndex === -1) wrongIndex = i;
                        validSpecs[i] = null;
                    }
                }
            }
            
            let finalSolution = Array(9).fill(null);
            solveSmart(0, finalSolution, new Set(fixedIDs), validSpecs);
            return { solution: finalSolution, wrongIndex: wrongIndex };
        }

        function forceSolve(manual = true) {
            clearInterval(timerInterval);
            
            setTimeout(() => {
                if (absoluteSolution) {
                    activeHint = null; 
                    
                    userBoard = absoluteSolution.map((b, i) => {
                        if (currentLayoutConfig[i].type === 'EMPTY') return null; 
                        return b ? {...b} : null;
                    });
                    
                    renderGameGrid();
                    
                    $('grid-container').classList.add('win-glow');
                    $('btn-solve').disabled = true; 
                    $('btn-reset').disabled = true; 
                    $('btn-next').style.display = 'inline-block'; 
                    $('top-ui-controls').style.display = 'none';
                    $('sprite-action-bar').style.display = 'none'; 
                    isRoundWon = true; 
                    isSolverUsed = true;
                    
                    if (manual) { 
                        let lvl = $('level-info'); 
                        lvl.innerText = "æ”¾æ£„ï¼Œå…¬å¸ƒè§£ç­”"; 
                        lvl.style.color = "#e74c3c"; 
                    }
                } else { 
                    alert("ç„¡æ³•ç²å–è§£ç­”ï¼"); 
                }
            }, 100);
        }
    </script>
</body>
</html>
